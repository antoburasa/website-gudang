<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SMS GUDANG v3.1 - FINAL REPAIR</title>
    <style>
        body { font-family: sans-serif; display: flex; margin: 0; background: #f0f2f5; }
        .sidebar { width: 200px; background: #1a237e; color: white; height: 100vh; padding: 20px; position: fixed; }
        .main { margin-left: 240px; padding: 20px; width: 100%; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-btn { display: block; width: 100%; padding: 10px; margin-bottom: 5px; background: none; color: white; border: none; text-align: left; cursor: pointer; border-radius: 4px; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); }
        .active-nav { background: #3949ab !important; font-weight: bold; }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-save { background: #1a237e; color: white; border: none; padding: 12px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .page { display: none; }
        .show { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>SMS GUDANG</h3>
    <button class="nav-btn active-nav" onclick="buka('dash', this)">Dashboard</button>
    <button class="nav-btn" onclick="buka('mast', this)">Master Barang</button>
    <button class="nav-btn" onclick="buka('trans', this)">Masuk / Keluar</button>
</div>

<div class="main">
    <div id="dash" class="page show">
        <h2>Stok Gudang</h2>
        <div class="card"><table id="tStok"><thead><tr><th>Barang</th><th>Stok</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="mast" class="page">
        <h2>Tambah Barang ke Sistem</h2>
        <div class="card" style="max-width:400px">
            <input type="text" id="m_nama" placeholder="Contoh: SEMEN">
            <button class="btn-save" onclick="saveMaster()">DAFTARKAN BARANG</button>
        </div>
        <div class="card">
            <table id="tMaster"><thead><tr><th>Nama Barang</th><th>Aksi</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="trans" class="page">
        <h2>Input Transaksi</h2>
        <div class="card" style="max-width:400px">
            <select id="t_pilih"></select>
            <select id="t_tipe"><option value="IN">MASUK (+)</option><option value="OUT">KELUAR (-)</option></select>
            <input type="number" id="t_qty" placeholder="Jumlah">
            <button class="btn-save" onclick="saveTrans()">SIMPAN DATA</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // 1. CONFIGURASI (Pastikan ID ini sama dengan di Firebase Adri)
    const firebaseConfig = {
        apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
        authDomain: "gudang-sms-4c81c.firebaseapp.com",
        databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gudang-sms-4c81c",
        storageBucket: "gudang-sms-4c81c.appspot.com",
        appId: "1:598362736106:web:c8e2732d6ac7613931de93"
    };
    
    // Inisialisasi
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // Fungsi Navigasi
    function buka(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
        document.getElementById(id).classList.add('show');
        el.classList.add('active-nav');
    }

    // SIMPAN MASTER
    function saveMaster() {
        const nama = document.getElementById('m_nama').value.toUpperCase().trim();
        if(!nama) return alert("Isi nama barang!");

        db.ref("master_barang").push({ nama: nama })
        .then(() => {
            alert("Berhasil simpan ke Master!");
            document.getElementById('m_nama').value = "";
        })
        .catch(error => {
            console.error(error);
            alert("GAGAL: Database menolak akses. Cek Rules Firebase Anda.");
        });
    }

    // SIMPAN TRANSAKSI
    function saveTrans() {
        const barang = document.getElementById('t_pilih').value;
        const tipe = document.getElementById('t_tipe').value;
        const qty = parseInt(document.getElementById('t_qty').value);
        if(!barang || isNaN(qty)) return alert("Isi barang & jumlah!");

        db.ref("riwayat").push({
            barang: barang,
            tipe: tipe,
            qty: qty,
            tgl: new Date().toLocaleDateString()
        })
        .then(() => {
            alert("Transaksi Berhasil!");
            document.getElementById('t_qty').value = "";
        })
        .catch(error => {
            console.error(error);
            alert("GAGAL: Tidak bisa simpan transaksi.");
        });
    }

    // MONITOR DATA SECARA REALTIME
    db.ref().on("value", (snap) => {
        const data = snap.val() || {};
        const master = data.master_barang || {};
        const riwayat = data.riwayat || {};

        // Update Tabel Master & Dropdown
        let hMst = "", hOpt = "<option value=''>-- PILIH --</option>";
        for(let id in master) {
            hMst += <tr><td>${master[id].nama}</td><td><button onclick="db.ref('master_barang/${id}').remove()" style="color:red">Hapus</button></td></tr>;
            hOpt += <option value="${master[id].nama}">${master[id].nama}</option>;
        }
        document.getElementById('tMaster').querySelector('tbody').innerHTML = hMst;
        document.getElementById('t_pilih').innerHTML = hOpt;

        // Hitung Stok
        let stok = {};
        for(let id in riwayat) {
            const r = riwayat[id];
            if(r.tipe === "IN") stok[r.barang] = (stok[r.barang] || 0) + r.qty;
            else stok[r.barang] = (stok[r.barang] || 0) - r.qty;
        }

        let hDash = "";
        for(let b in stok) {
            hDash += <tr><td><b>${b}</b></td><td>${stok[b]}</td></tr>;
        }
        document.getElementById('tStok').querySelector('tbody').innerHTML = hDash;
    }, error => {
        alert("Koneksi Firebase Gagal: " + error.message);
    });
</script>

</body>
</html>
