<!DOCTYPE html>
<html>
<head>
  <title>Gudang Rawmaterial SMS</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    body{font-family:Arial;background:#f4f6f8;margin:0}
    .menu{background:#1f2937;color:white;padding:10px}
    .menu button{margin-right:10px}
    .page{display:none;padding:20px}
    table{background:white;border-collapse:collapse;width:100%}
    th,td{padding:6px;border:1px solid #ccc}
    input,select{padding:4px}
    .printArea{background:white;padding:30px}
  </style>
</head>
<body>

<div class="menu">
  <button onclick="showPage('dashboard')">Dashboard</button>
  <button onclick="showPage('master')">Master Barang</button>
  <button onclick="showPage('prs')">Buat PRS</button>
  <button onclick="showPage('listprs')">List PRS</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="page">
  <h2>Gudang Rawmaterial SMS</h2>
</div>

<!-- MASTER -->
<div id="master" class="page">
  <h2>Master Barang</h2>
  <input id="kode" placeholder="Kode">
  <input id="nama" placeholder="Nama">
  <input id="unit" placeholder="Unit">
  <button onclick="simpanMaster()">Simpan</button>
  <br><br>
  <tbody id="masterList"></tbody>
</div>

<!-- BUAT PRS -->
<div id="prs" class="page">
  <h2>FORM PRS</h2>

  No PRS<br>
  <input id="noPrs" readonly><br><br>

  Tanggal<br>
  <input type="date" id="prsTanggal"><br><br>

  Charge To<br>
  <input id="prsCharge"><br><br>

  User<br>
  <input id="prsUser"><br><br>

  Departemen<br>
  <input id="prsDept"><br><br>

  <table>
    <thead>
      <tr>
        <th>Kode</th>
        <th>Nama</th>
        <th>Unit</th>
        <th>Qty</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="prsTable"></tbody>
  </table>

  <br>
  <button onclick="addPrsRow()">+ Barang</button>
  <button onclick="simpanPRS()">Simpan PRS</button>
</div>

<!-- LIST PRS -->
<div id="listprs" class="page">
  <h2>LIST PRS</h2>
  <table>
    <thead>
      <tr>
        <th>No PRS</th>
        <th>Tanggal</th>
        <th>User</th>
        <th>Departemen</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="listPRSTable"></tbody>
  </table>
</div>

<!-- PRINT -->
<div id="printPage" class="page printArea"></div>

<script>
/* FIREBASE CONFIG */
var firebaseConfig={
  apiKey:"APIKEY",
  authDomain:"PROJECT.firebaseapp.com",
  projectId:"PROJECTID"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.firestore();

/* NAV */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";

  if(id==="prs"){
    generatePRS();
    document.getElementById("prsTable").innerHTML="";
    addPrsRow();
  }

  if(id==="listprs") loadListPRS();
}
showPage("dashboard");

/* MASTER */
function simpanMaster(){
  const kode=kode.value;
  db.collection("master_barang").doc(kode).set({
    kode:kode,
    nama:nama.value,
    unit:unit.value
  }).then(()=>alert("Tersimpan"));
}

/* PRS */
function generatePRS(){
  document.getElementById("noPrs").value="PRS-"+Date.now();
}

async function addPrsRow(){
  const snap=await db.collection("master_barang").get();
  let opt="";
  snap.forEach(d=>{
    const x=d.data();
    opt+=`<option value="${x.kode}|${x.nama}|${x.unit}">
      ${x.kode}-${x.nama}
    </option>`;
  });

  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><select onchange="isiBarang(this)">${opt}</select></td>
    <td><input readonly></td>
    <td><input readonly></td>
    <td><input type="number"></td>
    <td><button onclick="this.closest('tr').remove()">X</button></td>
  `;
  prsTable.appendChild(tr);
}

function isiBarang(s){
  const v=s.value.split("|");
  const r=s.closest("tr");
  r.cells[1].children[0].value=v[1];
  r.cells[2].children[0].value=v[2];
}

async function simpanPRS(){
  const header={
    no:noPrs.value,
    tanggal:prsTanggal.value,
    charge:prsCharge.value,
    user:prsUser.value,
    dept:prsDept.value
  };

  await db.collection("prs_header").doc(header.no).set(header);

  const rows=document.querySelectorAll("#prsTable tr");
  for(const r of rows){
    await db.collection("prs_detail").add({
      no:header.no,
      kode:r.cells[0].children[0].value.split("|")[0],
      nama:r.cells[1].children[0].value,
      unit:r.cells[2].children[0].value,
      qty:r.cells[3].children[0].value
    });
  }

  alert("PRS tersimpan");
  showPage("listprs");
}

/* LIST PRS */
async function loadListPRS(){
  const body=document.getElementById("listPRSTable");
  body.innerHTML="";

  const snap=await db.collection("prs_header").get();
  snap.forEach(doc=>{
    const d=doc.data();
    body.innerHTML+=`
      <tr>
        <td>${d.no}</td>
        <td>${d.tanggal}</td>
        <td>${d.user}</td>
        <td>${d.dept}</td>
        <td>
          <button onclick="printPRS('${d.no}')">PRINT</button>
        </td>
      </tr>`;
  });
}

/* PRINT PRS */
async function printPRS(no){
  const header=(await db.collection("prs_header").doc(no).get()).data();

  const snap=await db.collection("prs_detail").where("no","==",no).get();

  let rows="";
  snap.forEach(d=>{
    const x=d.data();
    rows+=`
      <tr>
        <td>${x.kode}</td>
        <td>${x.nama}</td>
        <td>${x.unit}</td>
        <td>${x.qty}</td>
      </tr>`;
  });

  document.getElementById("printPage").innerHTML=`
    <h2>PURCHASE REQUISITION SLIP</h2>
    No PRS: ${header.no}<br>
    Tanggal: ${header.tanggal}<br>
    User: ${header.user}<br>
    Departemen: ${header.dept}<br><br>

    <table>
      <tr>
        <th>Kode</th>
        <th>Nama</th>
        <th>Unit</th>
        <th>Qty</th>
      </tr>
      ${rows}
    </table>
  `;

  showPage("printPage");
  window.print();
}
</script>
</body>
</html>
