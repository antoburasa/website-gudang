<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Gudang Raw Material SMS</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
nav{background:#1e3a8a;padding:10px}
nav button{margin:3px;padding:8px;border:0;background:white;border-radius:6px;cursor:pointer}
.card{background:white;margin:15px;padding:15px;border-radius:10px}
input,select{width:100%;padding:8px;margin:5px 0}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px}
.warn{background:#fee2e2}
</style>
</head>

<body>

<nav>
<button onclick="dashboard()">Dashboard</button>
<button onclick="master()">Master Barang</button>
<button onclick="masuk()">Barang Masuk</button>
<button onclick="keluar()">Barang Keluar</button>
<button onclick="stok()">Stok</button>
<button onclick="riwayat()">Riwayat</button>
</nav>

<div id="app"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
  databaseURL:"https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"gudang-sms-4c81c"
});
const db=firebase.database();
const app=document.getElementById("app");

/* ================= DATA ================= */
const daftarGudang=["General Store 1","General Store 2","Gudang 3","Ingredients"];

/* ================= DASHBOARD ================= */
function dashboard(){
db.ref("barang").once("value",s=>{
let total=0,jenis=0,perGudang={};
s.forEach(c=>{
let b=c.val();
total+=b.stok||0;
jenis++;
perGudang[b.gudang]=(perGudang[b.gudang]||0)+(b.stok||0);
});
let html=`<div class="card">
<h2>Dashboard</h2>
Total Stok: <b>${total}</b><br>
Jenis Barang: <b>${jenis}</b><hr>`;
for(let g in perGudang){
html+=${g}: <b>${perGudang[g]}</b><br>;
}
html+="</div>";
app.innerHTML=html;
});
}

/* ================= MASTER ================= */
function master(){
app.innerHTML=`
<div class="card">
<h3>Master Barang</h3>
Nama<input id="nama">
Kode<input id="kode">
Unit<input id="unit">
Minimum<input id="min" type="number">
Gudang<select id="gudang"></select>
<button onclick="simpanBarang()">Simpan</button>
</div>
<div class="card"><div id="listBarang"></div></div>`;
loadGudang();
loadMaster();
}

function loadGudang(){
gudang.innerHTML="";
daftarGudang.forEach(g=>gudang.innerHTML+=<option>${g}</option>);
}

function simpanBarang(){
db.ref("barang").push({
nama:nama.value,
kode:kode.value,
unit:unit.value,
gudang:gudang.value,
stok:0,
min:parseInt(min.value||0)
});
master();
}

function loadMaster(){
db.ref("barang").on("value",s=>{
let h="<table><tr><th>Nama</th><th>Gudang</th><th>Stok</th><th>Min</th></tr>";
s.forEach(c=>{
let b=c.val();
h+=`<tr class="${b.stok<=b.min?'warn':''}">
<td>${b.nama}</td><td>${b.gudang}</td>
<td>${b.stok}</td><td>${b.min}</td></tr>`;
});
h+="</table>";
listBarang.innerHTML=h;
});
}

/* ================= TRANSAKSI ================= */
function masuk(){formTrx("Masuk")}
function keluar(){formTrx("Keluar")}

function formTrx(t){
app.innerHTML=`
<div class="card">
<h3>Barang ${t}</h3>
Petugas<input id="petugas">
Barang<select id="bsel"></select>
Qty<input id="qty" type="number">
<button onclick="trx('${t}')">Simpan</button>
</div>`;
loadBarang();
}

function loadBarang(){
db.ref("barang").once("value",s=>{
bsel.innerHTML="";
s.forEach(c=>{
bsel.innerHTML+=<option value="${c.key}">${c.val().nama} - ${c.val().gudang}</option>;
});
});
}

function trx(t){
let ref=db.ref("barang/"+bsel.value);
ref.once("value",s=>{
let b=s.val();
let qtyN=parseInt(qty.value);
let stok=t==="Masuk"?(b.stok||0)+qtyN:(b.stok||0)-qtyN;
ref.update({stok});
db.ref("transaksi").push({
tipe:t,barang:b.nama,gudang:b.gudang,
qty:qtyN,petugas:petugas.value,tanggal:Date.now()
});
alert("Tersimpan");
});
}

/* ================= STOK ================= */
function stok(){
db.ref("barang").on("value",s=>{
let h="<div class='card'><h3>Stok</h3><table>";
h+="<tr><th>Barang</th><th>Gudang</th><th>Stok</th></tr>";
s.forEach(c=>{
let b=c.val();
h+=`<tr class="${b.stok<=b.min?'warn':''}">
<td>${b.nama}</td><td>${b.gudang}</td><td>${b.stok}</td></tr>`;
});
h+="</table></div>";
app.innerHTML=h;
});
}

/* ================= RIWAYAT ================= */
function riwayat(){
app.innerHTML=`
<div class="card">
<h3>Riwayat</h3>
Filter Gudang<select id="fg" onchange="loadRiwayat()">
<option value="">Semua</option>
${daftarGudang.map(g=><option>${g}</option>).join("")}
</select>
<div id="listR"></div>
</div>`;
loadRiwayat();
}

function loadRiwayat(){
db.ref("transaksi").on("value",s=>{
let f=fg.value;
let h="<table><tr><th>Tanggal</th><th>Tipe</th><th>Barang</th><th>Gudang</th><th>Qty</th><th>Petugas</th></tr>";
s.forEach(c=>{
let d=c.val();
if(f && d.gudang!==f) return;
h+=`<tr>
<td>${new Date(d.tanggal).toLocaleString()}</td>
<td>${d.tipe}</td><td>${d.barang}</td>
<td>${d.gudang}</td><td>${d.qty}</td><td>${d.petugas}</td>
</tr>`;
});
h+="</table>";
listR.innerHTML=h;
});
}

dashboard();
</script>

</body>
</html>