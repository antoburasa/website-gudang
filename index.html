<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUDANG ADRI FIX</title>
    <style>
        body { font-family: sans-serif; background: #eef2f5; padding: 10px; margin: 0; }
        .container { background: white; max-width: 500px; margin: 20px auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid #1a237e; }
        h2 { font-size: 14px; color: #1a237e; text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; background: #1a237e; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        button:active { background: #000; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .merah { background: #ffebee; color: #c62828; font-weight: bold; }
        .filter-box { background: #fff9c4; padding: 10px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color:#1a237e; margin:0; font-size:24px;">SMS GUDANG</h1>
    
    <h2>1. Tambah Barang</h2>
    <input type="text" id="nama_brg" placeholder="Nama Barang">
    <input type="number" id="stok_min" placeholder="Stok Minimal">
    <button onclick="simpanMaster()">TAMBAH KE DAFTAR</button>

    <h2>2. Transaksi</h2>
    <select id="pilih_brg"></select>
    <select id="tipe_trans">
        <option value="IN">MASUK (+)</option>
        <option value="OUT">KELUAR (-)</option>
    </select>
    <input type="number" id="qty_trans" placeholder="Jumlah">
    <button onclick="simpanTransaksi()" style="background:#2e7d32">SIMPAN TRANSAKSI</button>

    <h2>3. Stok Realtime</h2>
    <table>
        <thead><tr><th>Barang</th><th>Min</th><th>Stok</th><th>Ket</th></tr></thead>
        <tbody id="tabel_stok"></tbody>
    </table>

    <h2>4. Riwayat</h2>
    <div class="filter-box">
        <input type="text" id="cari" onkeyup="tampilData()" placeholder="Cari barang...">
    </div>
    <table>
        <thead><tr><th>Waktu</th><th>Barang</th><th>Qty</th><th>Aksi</th></tr></thead>
        <tbody id="tabel_riwayat"></tbody>
    </table>
</div>
 
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // Konfigurasi Database Adri
    const firebaseConfig = {
        apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
        authDomain: "gudang-sms-4c81c.firebaseapp.com",
        databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gudang-sms-4c81c",
        appId: "1:598362736106:web:c8e2732d6ac7613931de93"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Fungsi Tambah Master
    function simpanMaster() {
        const n = document.getElementById('nama_brg').value.toUpperCase().trim();
        const m = parseInt(document.getElementById('stok_min').value) || 0;
        if(!n) return alert("Isi nama barang!");
        database.ref("master_barang").push({ nama: n, limit: m });
        document.getElementById('nama_brg').value = "";
        document.getElementById('stok_min').value = "";
    }

    // Fungsi Transaksi
    function simpanTransaksi() {
        const b = document.getElementById('pilih_brg').value;
        const t = document.getElementById('tipe_trans').value;
        const q = parseInt(document.getElementById('qty_trans').value);
        const w = new Date().toLocaleString('id-ID', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
        if(!b || !q) return alert("Lengkapi data!");
        database.ref("riwayat").push({ barang: b, tipe: t, qty: q, waktu: w, ts: Date.now() });
        document.getElementById('qty_trans').value = "";
    }

    // Ambil Data
    database.ref().on("value", (snapshot) => {
        window.semuaData = snapshot.val() || {};
        tampilData();
    });

    function tampilData() {
        const data = window.semuaData;
        const master = data.master_barang || {};
        const riwayat = data.riwayat || {};
        const filter = document.getElementById('cari').value.toUpperCase();

        let listOpt = "<option value=''>-- Pilih Barang --</option>";
        let limits = {};
        for(let id in master) {
            listOpt += <option value="${master[id].nama}">${master[id].nama}</option>;
            limits[master[id].nama] = master[id].limit || 0;
        }
        document.getElementById('pilih_brg').innerHTML = listOpt;

        let stokHitung = {};
        let htmlRiw = "";
        const urutRiwayat = Object.keys(riwayat).sort((a,b) => riwayat[b].ts - riwayat[a].ts);

        urutRiwayat.forEach(id => {
            const r = riwayat[id];
            if(r.tipe === "IN") stokHitung[r.barang] = (stokHitung[r.barang] || 0) + r.qty;
            else stokHitung[r.barang] = (stokHitung[r.barang] || 0) - r.qty;

            if(r.barang.includes(filter)) {
                htmlRiw += <tr><td>${r.waktu}</td><td>${r.barang}</td><td>${r.tipe}:${r.qty}</td><td><button style="width:auto;padding:2px 5px;background:red;margin:0" onclick="database.ref('riwayat/${id}').remove()">X</button></td></tr>;
            }
        });
        document.getElementById('tabel_riwayat').innerHTML = htmlRiw;

        let htmlStok = "";
        for(let nama in limits) {
            const s = stokHitung[nama] || 0;
            const m = limits[nama];
            const isKritis = s <= m;
            htmlStok += <tr class="${isKritis ? 'merah' : ''}"><td>${nama}</td><td>${m}</td><td>${s}</td><td>${isKritis?'BELI':'OK'}</td></tr>;
        }
        document.getElementById('tabel_stok').innerHTML = htmlStok;
    }
</script>
</body>
</html>

