<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gudang SMS - Fix Version</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        nav { background: #1a365d; padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; border-radius: 8px; }
        nav button { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: white; color: #1a365d; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-top: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .status-msg { padding: 10px; margin-top: 5px; font-size: 12px; color: #666; }
    </style>
</head>
<body>

<nav>
    <button onclick="master()">ðŸ“¦ Master</button>
    <button onclick="formTrx('Masuk')">ðŸ“¥ Masuk</button>
    <button onclick="formTrx('Keluar')">ðŸ“¤ Keluar</button>
    <button onclick="stok()">ðŸ“Š Stok</button>
    <button onclick="riwayat()">ðŸ“œ Riwayat</button>
</nav>

<div id="status" class="status-msg">System Ready.</div>
<div id="app"></div>

<script>
// KONFIGURASI SESUAI GAMBAR ANDA
const firebaseConfig = {
    apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
    databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "gudang-sms-4c81c"
};

// Inisialisasi
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
const app = document.getElementById("app");
const statusDiv = document.getElementById("status");

function setStatus(msg) { statusDiv.innerText = "Status: " + msg; }

/* --- FUNGSI MASTER BARANG --- */
function master() {
    setStatus("Membuka Master Barang...");
    app.innerHTML = `
    <div class="card">
        <h3>Tambah Barang Baru</h3>
        <input id="nama" placeholder="Nama Barang (Contoh: Semen)">
        <input id="kode" placeholder="Kode Barang">
        <input id="unit" placeholder="Satuan (Pcs/Kg)">
        <input id="min" type="number" placeholder="Stok Minimal">
        <select id="gudang">
            <option>General Store 1</option>
            <option>General Store 2</option>
            <option>Gudang 3</option>
            <option>Ingredients</option>
        </select>
        <button class="btn-action" onclick="simpanBarang()">Simpan ke Database</button>
    </div>
    <div id="listBarang" class="card">Memuat data...</div>`;
    loadMaster();
}

function simpanBarang() {
    const data = {
        nama: document.getElementById("nama").value,
        kode: document.getElementById("kode").value,
        unit: document.getElementById("unit").value,
        gudang: document.getElementById("gudang").value,
        stok: 0,
        min: parseInt(document.getElementById("min").value || 0)
    };

    if(!data.nama || !data.kode) return alert("Isi Nama dan Kode!");

    db.ref("barang").push(data)
        .then(() => { alert("Berhasil disimpan!"); master(); })
        .catch(e => alert("Error: " + e.message));
}

function loadMaster() {
    db.ref("barang").on("value", s => {
        let h = "<h3>Daftar Barang</h3><table><tr><th>Nama</th><th>Gudang</th><th>Stok</th></tr>";
        s.forEach(c => {
            let b = c.val();
            h += <tr><td>${b.nama}</td><td>${b.gudang}</td><td>${b.stok} ${b.unit}</td></tr>;
        });
        h += "</table>";
        document.getElementById("listBarang").innerHTML = h;
    });
}

/* --- FUNGSI TRANSAKSI --- */
function formTrx(tipe) {
    setStatus("Membuka Form " + tipe);
    app.innerHTML = `
    <div class="card">
        <h3>Barang ${tipe}</h3>
        <input id="petugas" placeholder="Nama Petugas">
        <select id="barangPilih"><option>Memuat barang...</option></select>
        <input id="qty" type="number" placeholder="Jumlah">
        <button class="btn-action" onclick="prosesTrx('${tipe}')">Proses ${tipe}</button>
    </div>`;
    
    db.ref("barang").once("value", s => {
        let sel = document.getElementById("barangPilih");
        sel.innerHTML = "";
        s.forEach(c => {
            sel.innerHTML += <option value="${c.key}">${c.val().nama} (${c.val().gudang})</option>;
        });
    });
}

function prosesTrx(tipe) {
    const id = document.getElementById("barangPilih").value;
    const qty = parseInt(document.getElementById("qty").value);
    const pet = document.getElementById("petugas").value;

    if(!id || !qty || !pet) return alert("Lengkapi form!");

    const ref = db.ref("barang/" + id);
    ref.once("value", s => {
        let b = s.val();
        let stokSkrg = b.stok || 0;
        
        if(tipe === "Keluar" && stokSkrg < qty) return alert("Stok tidak cukup!");

        let stokBaru = (tipe === "Masuk") ? stokSkrg + qty : stokSkrg - qty;

        ref.update({ stok: stokBaru }).then(() => {
            db.ref("transaksi").push({
                tipe: tipe, barang: b.nama, qty: qty, petugas: pet, tanggal: Date.now()
            });
            alert("Berhasil!");
            formTrx(tipe);
        });
    });
}

/* --- FUNGSI STOK & RIWAYAT --- */
function stok() {
    setStatus("Melihat Stok...");
    app.innerHTML = <div class="card" id="viewStok">Memuat...</div>;
    loadMaster(); // Menggunakan fungsi yang sama untuk tampilan tabel
}

function riwayat() {
    setStatus("Melihat Riwayat...");
    app.innerHTML = <div class="card" id="viewR">Memuat...</div>;
    db.ref("transaksi").limitToLast(20).on("value", s => {
        let h = "<h3>20 Transaksi Terakhir</h3><table><tr><th>Tipe</th><th>Barang</th><th>Qty</th></tr>";
        s.forEach(c => {
            let d = c.val();
            h += <tr><td>${d.tipe}</td><td>${d.barang}</td><td>${d.qty}</td></tr>;
        });
        h += "</table>";
        document.getElementById("viewR").innerHTML = h;
    });
}

// Jalankan Master di awal
master();
</script>
</body>
</html>