<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS GUDANG PRO - ADRI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a237e;
            --success: #2e7d32;
            --danger: #c62828;
            --bg: #f4f7f9;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            padding: 10px; 
            color: #333;
        }

        .container { 
            max-width: 800px; 
            margin: 20px auto; 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-top: 8px solid var(--primary);
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 5px; font-weight: 800; }
        p.subtitle { text-align: center; color: #666; font-size: 13px; margin-bottom: 30px; }

        h2 { 
            font-size: 16px; 
            text-transform: uppercase; 
            color: var(--primary); 
            border-left: 4px solid var(--primary); 
            padding-left: 10px; 
            margin-top: 30px;
        }

        .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px; 
            box-sizing: border-box;
            outline: none;
        }

        input:focus { border-color: var(--primary); }

        button { 
            width: 100%; 
            padding: 14px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.3s;
            font-size: 14px;
        }

        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-save { background: var(--success); }

        /* Tabel Styles */
        .table-container { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; color: #666; font-weight: 600; }

        /* Status Stok */
        .stok-kritis { 
            background-color: #fff5f5; 
            color: var(--danger); 
            font-weight: bold; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0% { background-color: #fff5f5; } 
            50% { background-color: #ffe0e0; } 
            100% { background-color: #fff5f5; } 
        }

        .badge { 
            padding: 3px 8px; 
            border-radius: 5px; 
            font-size: 11px; 
            color: white; 
            font-weight: bold; 
        }
        .bg-in { background: var(--success); }
        .bg-out { background: var(--danger); }

        .filter-box { 
            background: #eef2f7; 
            padding: 15px; 
            border-radius: 10px; 
            margin: 15px 0; 
        }

        .btn-del { 
            background: #ff5252; 
            padding: 5px 10px; 
            font-size: 11px; 
            width: auto; 
            display: inline-block;
        }

        @media (max-width: 600px) {
            .input-group { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SMS GUDANG PRO</h1>
    <p class="subtitle">Sistem Monitoring Stok Realtime - User: Adri</p>

    <h2>1. Daftarkan Barang Baru</h2>
    <div class="input-group">
        <input type="text" id="m_nama" placeholder="Nama Barang (BESI, SEMEN, dll)" style="text-transform: uppercase;">
        <input type="number" id="m_min" placeholder="Batas Stok Minimum">
    </div>
    <button onclick="simpanMaster()">+ TAMBAHKAN KE MASTER</button>

    <h2>2. Input Barang Masuk / Keluar</h2>
    <select id="t_pilih_barang">
        <option value="">-- PILIH BARANG --</option>
    </select>
    <div class="input-group" style="margin-top: 10px;">
        <select id="t_tipe">
            <option value="IN">BARANG MASUK (+)</option>
            <option value="OUT">BARANG KELUAR (-)</option>
        </select>
        <input type="number" id="t_qty" placeholder="Jumlah (Qty)">
    </div>
    <button class="btn-save" onclick="simpanTransaksi()">üíæ SIMPAN TRANSAKSI</button>

    <h2>3. Status Stok & Warning</h2>
    <div class="table-container">
        <table id="tblStok">
            <thead>
                <tr>
                    <th>Nama Barang</th>
                    <th>Batas Min</th>
                    <th>Stok Saat Ini</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h2>4. Riwayat Transaksi</h2>
    <div class="filter-box">
        <label style="font-size: 12px; font-weight: bold;">üîç CARI TRANSAKSI:</label>
        <input type="text" id="pencarian" onkeyup="renderData()" placeholder="Ketik nama barang...">
    </div>
    <div class="table-container">
        <table id="tblRiwayat">
            <thead>
                <tr>
                    <th>Tanggal & Waktu</th>
                    <th>Barang</th>
                    <th>Tipe</th>
                    <th>Qty</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="bodyRiwayat"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // KONFIGURASI FIREBASE ADRI
    const firebaseConfig = {
        apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
        authDomain: "gudang-sms-4c81c.firebaseapp.com",
        databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gudang-sms-4c81c",
        appId: "1:598362736106:web:c8e2732d6ac7613931de93"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // FUNGSI 1: SIMPAN MASTER BARANG
    function simpanMaster() {
        const nama = document.getElementById('m_nama').value.toUpperCase().trim();
        const min = parseInt(document.getElementById('m_min').value) || 0;
        
        if(!nama) return alert("Nama barang tidak boleh kosong!");
        
        db.ref("master_barang").push({ 
            nama: nama, 
            limit: min 
        }).then(() => {
            document.getElementById('m_nama').value = "";
            document.getElementById('m_min').value = "";
            alert("Barang berhasil didaftarkan!");
        });
    }

    // FUNGSI 2: SIMPAN TRANSAKSI
    function simpanTransaksi() {
        const barang = document.getElementById('t_pilih_barang').value;
        const tipe = document.getElementById('t_tipe').value;
        const qty = parseInt(document.getElementById('t_qty').value);
        const waktu = new Date().toLocaleString('id-ID', { 
            dateStyle: 'medium', 
            timeStyle: 'short' 
        });

        if(!barang || isNaN(qty)) return alert("Lengkapi data transaksi!");

        db.ref("riwayat").push({
            barang: barang,
            tipe: tipe,
            qty: qty,
            waktu: waktu,
            timestamp: Date.now()
        }).then(() => {
            document.getElementById('t_qty').value = "";
            alert("Transaksi Berhasil!");
        });
    }

    // FUNGSI 3: RENDER DATA (REALTIME)
    db.ref().on("value", function(snap) {
        const data = snap.val() || {};
        const master = data.master_barang || {};
        const riwayat = data.riwayat || {};
        
        // Update Dropdown
        let htmlDropdown = "<option value=''>-- PILIH BARANG --</option>";
        let limits = {};
        for(let id in master) {
            htmlDropdown += <option value="${master[id].nama}">${master[id].nama}</option>;
            limits[master[id].nama] = master[id].limit || 0;
        }
        document.getElementById('t_pilih_barang').innerHTML = htmlDropdown;

        window.fullMaster = limits;
        window.fullRiwayat = riwayat;
        renderData();
    });

    function renderData() {
        const limits = window.fullMaster || {};
        const riwayat = window.fullRiwayat || {};
        const cari = document.getElementById('pencarian').value.toUpperCase();

        let hitungStok = {};
        let htmlRiw = "";
        
        // Urutkan riwayat terbaru di atas
        const urutan = Object.keys(riwayat).sort((a,b) => riwayat[b].timestamp - riwayat[a].timestamp);

        urutan.forEach(id => {
            const r = riwayat[id];
            // Hitung Stok
            if(r.tipe === "IN") {
                hitungStok[r.barang] = (hitungStok[r.barang] || 0) + r.qty;
            } else {
                hitungStok[r.barang] = (hitungStok[r.barang] || 0) - r.qty;
            }

            // Render Riwayat dengan Filter
            if(r.barang.includes(cari)) {
                htmlRiw += `<tr>
                    <td>${r.waktu}</td>
                    <td><b>${r.barang}</b></td>
                    <td><span class="badge ${r.tipe === 'IN' ? 'bg-in' : 'bg-out'}">${r.tipe}</span></td>
                    <td>${r.qty}</td>
                    <td><button class="btn-del" onclick="hapus('riwayat/${id}')">Hapus</button></td>
                </tr>`;
            }
        });
        document.getElementById('bodyRiwayat').innerHTML = htmlRiw;

        // Render Tabel Stok & Cek Limit
        let htmlStok = "";
        for(let nama in limits) {
            const sAkhir = hitungStok[nama] || 0;
            const sMin = limits[nama];
            const kritis = sAkhir <= sMin;

            htmlStok += `<tr class="${kritis ? 'stok-kritis' : ''}">
                <td>${nama}</td>
                <td>${sMin}</td>
                <td>${sAkhir}</td>
                <td>${kritis ? '‚ö†Ô∏è RE-STOCK' : '‚úÖ AMAN'}</td>
            </tr>`;
        }
        document.getElementById('tblStok').querySelector('tbody').innerHTML = htmlStok;
    }

    function hapus(path) {
        if(confirm("Hapus data ini secara permanen?")) {
            db.ref(path).remove();
        }
    }
</script>

</body>
</html>
