<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
        authDomain: "gudang-sms-4c81c.firebaseapp.com",
        databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gudang-sms-4c81c",
        storageBucket: "gudang-sms-4c81c.appspot.com",
        appId: "1:598362736106:web:c8e2732d6ac7613931de93"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function prosesSimpan() {
        const barangInput = document.getElementById("barang");
        const jumlahInput = document.getElementById("jumlah");
        const jenisInput = document.getElementById("jenis");
        const btn = document.getElementById("btnSimpan");

        const barangNama = barangInput.value.trim().toUpperCase();
        const jumlahNilai = parseInt(jumlahInput.value);
        const jenisAksi = jenisInput.value;

        if (barangNama === "" || isNaN(jumlahNilai) || jumlahNilai <= 0) {
            alert("Mohon isi nama barang dan jumlah dengan benar!");
            return;
        }

        btn.disabled = true;
        btn.innerText = "MENYIMPAN...";

        database.ref("riwayat").push({
            barang: barangNama,
            jumlah: jumlahNilai,
            jenis: jenisAksi,
            tanggal: new Date().toISOString().slice(0, 10)
        })
        .then(() => {
            barangInput.value = "";
            jumlahInput.value = "";
            btn.disabled = false;
            btn.innerText = "SIMPAN DATA KE DATABASE";
        })
        .catch((error) => {
            alert(error.message);
            btn.disabled = false;
            btn.innerText = "SIMPAN DATA KE DATABASE";
        });
    }

    function muatData() {
        database.ref("riwayat").off();

        const tglAwal = document.getElementById("tglAwal").value;
        const tglAkhir = document.getElementById("tglAkhir").value;

        database.ref("riwayat").on("value", (snapshot) => {
            let htmlTabel = "";
            let petaStok = {};
            let totalUnit = 0;

            snapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                if (!data || !data.barang) return;

                const jenisData = data.jenis || "masuk";
                const jumlahData = parseInt(data.jumlah) || 0;

                if (tglAwal && data.tanggal < tglAwal) return;
                if (tglAkhir && data.tanggal > tglAkhir) return;

                if (jenisData === "masuk") {
                    petaStok[data.barang] = (petaStok[data.barang] || 0) + jumlahData;
                    totalUnit += jumlahData;
                } else {
                    petaStok[data.barang] = (petaStok[data.barang] || 0) - jumlahData;
                    totalUnit -= jumlahData;
                }

                htmlTabel += `
                    <tr>
                        <td>${data.tanggal || "-"}</td>
                        <td style="text-align:left"><b>${data.barang}</b></td>
                        <td style="color:${jenisData === 'masuk' ? '#28a745' : '#dc3545'}">
                            <b>${jenisData.toUpperCase()}</b>
                        </td>
                        <td>${jumlahData}</td>
                        <td class="no-print">
                            <button class="btn-danger" onclick="hapusData('${childSnapshot.key}')">
                                HAPUS
                            </button>
                        </td>
                    </tr>`;
            });

            document.getElementById("riwayatBody").innerHTML =
                htmlTabel || "<tr><td colspan='5'>Tidak ada data.</td></tr>";

            document.getElementById("totalStok").innerText = totalUnit;
            document.getElementById("totalJenis").innerText = Object.keys(petaStok).length;

            let ringkasanHtml = "";
            for (let namaBarang in petaStok) {
                ringkasanHtml += `
                    <div class="stok-item">
                        <span>${namaBarang}</span>
                        <b>${petaStok[namaBarang]} UNIT</b>
                    </div>`;
            }

            document.getElementById("ringkasanStok").innerHTML =
                ringkasanHtml || "Belum ada stok terdaftar.";
        });
    }

    function hapusData(id) {
        if (confirm("Hapus data transaksi ini?")) {
            database.ref("riwayat/" + id).remove();
        }
    }

    function eksporExcel() {
        const table = document.getElementById("tabelRiwayat");
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, "Laporan_Gudang_SMS.xlsx");
    }

    window.onload = muatData;
</script>
