<script>
    function muatData() {
        database.ref("riwayat").on("value", (snapshot) => {
            let html = ""; let stok = {}; let limit = {}; let totalUnit = 0;
            let listRiwayat = [];

            snapshot.forEach((snap) => {
                const d = snap.val();
                // Hitung Stok (Selalu jalankan ini tanpa filter)
                if (d.jenis === "masuk") {
                    stok[d.barang] = (stok[d.barang] || 0) + parseInt(d.jumlah);
                    if(d.stok_min > 0) limit[d.barang] = d.stok_min;
                } else {
                    stok[d.barang] = (stok[d.barang] || 0) - parseInt(d.jumlah);
                }
                listRiwayat.push({id: snap.key, ...d});
            });

            // Tampilkan ke Dashboard
            let sHtml = "";
            for (let brg in stok) {
                totalUnit += stok[brg];
                let isKritis = limit[brg] && stok[brg] <= limit[brg];
                sHtml += `<div class="alert-low" style="${isKritis ? 'background:#fee2e2; border-left:4px solid red' : ''}">
                    <div><b>${brg}</b><br><small>Sisa: ${stok[brg]}</small></div>
                    <div style="color:${isKritis?'red':'green'}">${isKritis?'⚠️ KRITIS':'✅ AMAN'}</div>
                </div>`;
            }
            document.getElementById("totalStok").innerText = totalUnit;
            document.getElementById("totalJenis").innerText = Object.keys(stok).length;
            document.getElementById("ringkasanStok").innerHTML = sHtml || "Belum ada data.";
            
            // Tampilkan ke Tabel Riwayat (Terbaru di atas)
            listRiwayat.reverse().forEach(d => {
                html += <tr><td>${d.tanggal}</td><td>${d.barang}</td><td>${d.jenis}</td><td>${d.jumlah}</td><td>${d.supplier}</td><td>${d.no_po}</td><td><button onclick="hapus('${d.id}')">X</button></td></tr>;
            });
            document.getElementById("riwayatBody").innerHTML = html;
        });
    }
</script>
