<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gudang SMS v3.0</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">

    <div class="max-w-md mx-auto space-y-4">
        <div class="bg-blue-900 text-white p-4 rounded-t-lg text-center font-bold">
            PT. SAMUDRA MANDIRI SENTOSA
        </div>

        <button onclick="tesKoneksi()" class="w-full bg-gray-200 text-gray-700 py-1 text-xs rounded border border-gray-300">
            KLIK SINI UNTUK TES KONEKSI
        </button>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
            <h2 class="text-sm font-bold text-green-700 mb-3 uppercase">Barang Masuk</h2>
            <input type="text" id="namaMasuk" placeholder="Nama Barang" class="w-full p-2 mb-2 border rounded">
            <input type="number" id="jmlMasuk" placeholder="Jumlah" class="w-full p-2 mb-3 border rounded">
            <button onclick="prosesData('masuk')" class="w-full bg-green-600 text-white py-3 rounded font-bold">SIMPAN MASUK</button>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
            <h2 class="text-sm font-bold text-red-700 mb-3 uppercase">Barang Keluar</h2>
            <input type="text" id="namaKeluar" placeholder="Nama Barang" class="w-full p-2 mb-2 border rounded">
            <input type="number" id="jmlKeluar" placeholder="Jumlah" class="w-full p-2 mb-3 border rounded">
            <button onclick="prosesData('keluar')" class="w-full bg-red-600 text-white py-3 rounded font-bold">KURANGI STOK</button>
        </div>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="bg-gray-800 text-white p-2 text-xs font-bold">RIWAYAT TERAKHIR</div>
            <table class="w-full text-xs text-left">
                <tbody id="tabelRiwayat" class="divide-y"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Konfigurasi Database Adri
        const firebaseConfig = {
            apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
            authDomain: "gudang-sms-4c81c.firebaseapp.com",
            databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gudang-sms-4c81c",
            storageBucket: "gudang-sms-4c81c.firebasestorage.app",
            messagingSenderId: "598362736106",
            appId: "1:598362736106:web:c8e2732d6ac7613931de93"
        };
        
        // Inisialisasi
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // Fungsi Cek Koneksi
        function tesKoneksi() {
            alert("Sistem Merespons! Jika tombol simpan tetap tidak jalan, periksa Nama Barang dan Jumlah.");
        }

        // Fungsi Utama
        function prosesData(tipe) {
            console.log("Memulai proses " + tipe);
            
            const nama = document.getElementById(tipe === 'masuk' ? 'namaMasuk' : 'namaKeluar').value.trim();
            const jmlInput = document.getElementById(tipe === 'masuk' ? 'jmlMasuk' : 'jmlKeluar').value;
            const jml = parseInt(jmlInput);
            const waktu = new Date().toLocaleTimeString();

            if (!nama || isNaN(jml)) {
                alert("NAMA dan JUMLAH tidak boleh kosong!");
                return;
            }

            const refStok = db.ref('stok/' + nama.toLowerCase());
            const refLog = db.ref('riwayat').push();

            refStok.once('value').then(s => {
                let stokLama = s.exists() ? parseInt(s.val().stok) : 0;
                let stokBaru = (tipe === 'masuk') ? (stokLama + jml) : (stokLama - jml);

                if (stokBaru < 0) {
                    alert("Gagal: Stok tidak cukup!");
                    return;
                }

                return Promise.all([
                    refStok.update({ nama: nama, stok: stokBaru, update: waktu }),
                    refLog.set({ waktu, tipe, nama, jml: (tipe === 'masuk' ? '+' : '-') + jml })
                ]);
            }).then(() => {
                alert("BERHASIL!");
                location.reload(); // Paksa refresh setelah berhasil
            }).catch(err => {
                alert("ERROR DATABASE: " + err