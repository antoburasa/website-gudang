<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUDANG ADRI PRO</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f0f2f5; margin: 0; }
        .box { background: white; padding: 20px; border-radius: 10px; max-width: 600px; margin: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid #1a237e; }
        h2 { color: #1a237e; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #1a237e; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background: #f8f9fa; }
        .kritis { background: #ffebee; color: #c62828; font-weight: bold; }
        .filter { background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="box">
    <h1 style="text-align:center; color:#1a237e; margin:0;">SMS GUDANG</h1>
    
    <h2>1. DAFTAR BARANG</h2>
    <input type="text" id="m" placeholder="Nama Barang Baru">
    <input type="number" id="min" placeholder="Stok Minimum">
    <button onclick="addM()">+ TAMBAH BARANG</button>

    <h2>2. TRANSAKSI</h2>
    <select id="p_list"></select>
    <select id="tipe">
        <option value="IN">MASUK (+)</option>
        <option value="OUT">KELUAR (-)</option>
    </select>
    <input type="number" id="qty" placeholder="Jumlah">
    <button onclick="addT()" style="background:#2e7d32">ðŸ’¾ SIMPAN</button>

    <h2>3. LAPORAN STOK</h2>
    <table>
        <thead><tr><th>Barang</th><th>Min</th><th>Sisa</th><th>Status</th></tr></thead>
        <tbody id="b_stok"></tbody>
    </table>

    <h2>4. RIWAYAT</h2>
    <div class="filter">
        <input type="text" id="cari" onkeyup="render()" placeholder="Cari barang...">
    </div>
    <table id="tbl_r">
        <thead><tr><th>Waktu</th><th>Barang</th><th>Qty</th><th>Aksi</th></tr></thead>
        <tbody id="b_riw"></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const cfg = {
        apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
        authDomain: "gudang-sms-4c81c.firebaseapp.com",
        databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gudang-sms-4c81c",
        appId: "1:598362736106:web:c8e2732d6ac7613931de93"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    function addM() {
        let n = document.getElementById('m').value.toUpperCase();
        let l = parseInt(document.getElementById('min').value) || 0;
        if(!n) return alert("Isi nama!");
        db.ref("master_barang").push({ nama: n, limit: l }).then(() => {
            document.getElementById('m').value = "";
            document.getElementById('min').value = "";
        });
    }

    function addT() {
        let b = document.getElementById('p_list').value;
        let t = document.getElementById('tipe').value;
        let q = parseInt(document.getElementById('qty').value);
        let w = new Date().toLocaleString('id-ID', {hour:'2-digit', minute:'2-digit', day:'numeric', month:'short'});
        if(!b || !q) return alert("Lengkapi!");
        db.ref("riwayat").push({ barang: b, tipe: t, qty: q, waktu: w, ts: Date.now() });
        document.getElementById('qty').value = "";
    }

    db.ref().on("value", snap => {
        window.raw = snap.val() || {};
        render();
    });

    function render() {
        let d = window.raw;
        let mst = d.master_barang || {};
        let riw = d.riwayat || {};
        let cari = document.getElementById('cari').value.toUpperCase();

        let opt = "<option value=''>-- PILIH --</option>";
        let limits = {};
        for(let id in mst) {
            opt += <option value="${mst[id].nama}">${mst[id].nama}</option>;
            limits[mst[id].nama] = mst[id].limit || 0;
        }
        document.getElementById('p_list').innerHTML = opt;

        let stok = {};
        let h_riw = "";
        let urut = Object.keys(riw).sort((a,b) => riw[b].ts - riw[a].ts);
        
        urut.forEach(id => {
            let r = riw[id];
            if(r.tipe === "IN") stok[r.barang] = (stok[r.barang] || 0) + r.qty;
            else stok[r.barang] = (stok[r.barang] || 0) - r.qty;

            if(r.barang.includes(cari)) {
                h_riw += <tr><td>${r.waktu}</td><td>${r.barang}</td><td>${r.tipe}:${r.qty}</td><td><button style="width:auto;padding:2px 5px;background:red" onclick="db.ref('riwayat/${id}').remove()">X</button></td></tr>;
            }
        });
        document.getElementById('b_riw').innerHTML = h_riw;

        let h_stok = "";
        for(let n in limits) {
            let s = stok[n] || 0;
            let m = limits[n];
            let k = s <= m ? "kritis" : "";
            h_stok += <tr class="${k}"><td>${n}</td><td>${m}</td><td>${s}</td><td>${s<=m?'BELI':'OK'}</td></tr>;
        }
        document.getElementById('b_stok').innerHTML = h_stok;
    }
</script>
</body>
</html>
