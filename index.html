<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Aplikasi Stok Barang</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:20px}
input,button{padding:5px;margin:3px}
table{border-collapse:collapse;width:100%;margin-top:10px}
th,td{border:1px solid #999;padding:6px;text-align:center}
h2{margin-top:30px}
</style>
</head>

<body>

<h1>Aplikasi Stok Barang</h1>

<!-- ================= TAMBAH BARANG ================= -->
<h2>Tambah Barang</h2>
<input id="namaBarang" placeholder="Nama Barang">
<input id="stokAwal" type="number" placeholder="Stok Awal">
<button onclick="tambahBarang()">Tambah</button>

<!-- ================= DAFTAR BARANG ================= -->
<h2>Daftar Barang</h2>
<table>
<thead>
<tr>
<th>Nama</th><th>Stok</th><th>Masuk</th><th>Keluar</th><th>Aksi</th>
</tr>
</thead>
<tbody id="tabelBarang"></tbody>
</table>

<!-- ================= RIWAYAT ================= -->
<h2>Riwayat Transaksi</h2>
<input type="date" id="filterTanggal">
<button onclick="loadRiwayat()">Filter</button>
<button onclick="exportExcel()">Export Excel</button>
<button onclick="window.print()">Print</button>

<table>
<thead>
<tr>
<th>Tanggal</th><th>Barang</th><th>Jenis</th><th>Jumlah</th>
</tr>
</thead>
<tbody id="tabelRiwayat"></tbody>
</table>

<script>
/* ================= FIREBASE CONFIG ================= */
var firebaseConfig = {
  apiKey: "ISI_API_KEY",
  authDomain: "ISI_AUTH_DOMAIN",
  databaseURL: "ISI_DATABASE_URL",
  projectId: "ISI_PROJECT_ID",
  storageBucket: "ISI_STORAGE",
  messagingSenderId: "ISI_SENDER_ID",
  appId: "ISI_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= TAMBAH BARANG ================= */
function tambahBarang(){
  const nama = namaBarang.value;
  const stok = parseInt(stokAwal.value);
  if(!nama || isNaN(stok)) return alert("Lengkapi data");

  db.ref("barang").push({
    nama:nama,
    stok:stok
  });

  namaBarang.value="";
  stokAwal.value="";
}

/* ================= LOAD BARANG ================= */
db.ref("barang").on("value", snap=>{
  tabelBarang.innerHTML="";
  if(!snap.exists()){
    tabelBarang.innerHTML="<tr><td colspan='5'>Belum ada barang</td></tr>";
    return;
  }

  snap.forEach(item=>{
    const b=item.val();
    const id=item.key;
    tabelBarang.innerHTML+=`
      <tr>
        <td>${b.nama}</td>
        <td>${b.stok}</td>
        <td><button onclick="transaksi('${id}','Masuk')">+</button></td>
        <td><button onclick="transaksi('${id}','Keluar')">-</button></td>
        <td>
          <button onclick="editBarang('${id}','${b.nama}',${b.stok})">Edit</button>
          <button onclick="hapusBarang('${id}')">Hapus</button>
        </td>
      </tr>`;
  });
});

/* ================= TRANSAKSI ================= */
function transaksi(id,jenis){
  const jumlah=prompt("Jumlah?");
  if(!jumlah) return;

  db.ref("barang/"+id).once("value",snap=>{
    let b=snap.val();
    let stok=b.stok;

    stok = jenis=="Masuk" ? stok+parseInt(jumlah) : stok-parseInt(jumlah);
    if(stok<0) return alert("Stok tidak cukup");

    db.ref("barang/"+id).update({stok:stok});

    db.ref("riwayat").push({
      tanggal:new Date().toISOString().slice(0,10),
      barang:b.nama,
      jenis:jenis,
      jumlah:jumlah
    });
  });
}

/* ================= EDIT & HAPUS ================= */
function editBarang(id,nama,stok){
  const n=prompt("Nama",nama);
  const s=prompt("Stok",stok);
  if(n && s){
    db.ref("barang/"+id).update({nama:n,stok:parseInt(s)});
  }
}

function hapusBarang(id){
  if(confirm("Hapus barang?")){
    db.ref("barang/"+id).remove();
  }
}

/* ================= RIWAYAT ================= */
function loadRiwayat(){
  const f=filterTanggal.value;
  tabelRiwayat.innerHTML="";

  db.ref("riwayat").once("value",snap=>{
    if(!snap.exists()){
      tabelRiwayat.innerHTML="<tr><td colspan='4'>Belum ada transaksi</td></tr>";
      return;
    }
    snap.forEach(i=>{
      const r=i.val();
      if(!f || r.tanggal==f){
        tabelRiwayat.innerHTML+=`
        <tr>
          <td>${r.tanggal}</td>
          <td>${r.barang}</td>
          <td>${r.jenis}</td>
          <td>${r.jumlah}</td>
        </tr>`;
      }
    });
  });
}
loadRiwayat();

/* ================= EXPORT EXCEL ================= */
function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(document.querySelector("table:last-of-type"));
  XLSX.utils.book_append_sheet(wb,ws,"Riwayat");
  XLSX.writeFile(wb,"riwayat_transaksi.xlsx");
}
</script>

</body>
</html>
