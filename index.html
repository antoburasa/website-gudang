<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =============================
   NAVIGASI
============================= */
function showPage(pageId, el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+pageId).classList.add('active');
  el.classList.add('active');
}

/* =============================
   SIMPAN DATA (FIX TOTAL)
============================= */
function simpanData(tipe){
  const barang = (tipe==='masuk'?in_barang:out_barang).value.trim().toUpperCase();
  const jumlah = parseInt(tipe==='masuk'?in_jumlah.value:out_jumlah.value);

  if(!barang || !jumlah || jumlah<=0){
    alert("Data belum lengkap");
    return;
  }

  const refBarang = db.ref("barang/"+barang);

  refBarang.once("value", snap=>{
    let stok = snap.exists()? snap.val().stok : 0;
    let stokMin = tipe==='masuk'? (parseInt(in_min.value)||0) : (snap.val()?.stok_min||0);

    if(tipe==='keluar' && stok < jumlah){
      alert("❌ Stok tidak mencukupi");
      return;
    }

    const stokBaru = tipe==='masuk' ? stok+jumlah : stok-jumlah;

    // UPDATE STOK
    refBarang.set({
      stok: stokBaru,
      stok_min: stokMin
    });

    // SIMPAN RIWAYAT
    db.ref("riwayat").push({
      barang, jumlah, jenis: tipe,
      tanggal: new Date().toISOString().slice(0,10),
      supplier: tipe==='masuk'?in_supplier.value:"-",
      dept: tipe==='masuk'?in_dept.value:"-",
      no_po: tipe==='masuk'?in_po.value:"-",
      no_prs: tipe==='masuk'?in_prs.value:"-"
    });

    alert("✅ Data tersimpan");
    document.querySelectorAll("input").forEach(i=>i.value="");
  });
}

/* =============================
   DASHBOARD & STOK
============================= */
function loadBarang(){
  db.ref("barang").on("value", snap=>{
    let totalStok=0, jenis=0, html="";
    snap.forEach(s=>{
      jenis++;
      totalStok+=s.val().stok;
      const kritis = s.val().stok <= s.val().stok_min;
      html+=`
        <div class="alert-low">
          <div>
            <b>${s.key}</b><br>
            Sisa: ${s.val().stok}
          </div>
          <div class="warning-text">${kritis?'⚠️ KRITIS':'AMAN'}</div>
        </div>`;
    });
    totalStokEl.innerText=totalStok;
    totalJenisEl.innerText=jenis;
    ringkasanStok.innerHTML=html||"Belum ada data";
  });
}

/* =============================
   RIWAYAT
============================= */
function muatData(){
  db.ref("riwayat").on("value", snap=>{
    let html="";
    snap.forEach(s=>{
      const d=s.val();
      html+=`
        <tr>
          <td>${d.tanggal}</td>
          <td>${d.barang}</td>
          <td><span class="badge-${d.jenis}">${d.jenis}</span></td>
          <td>${d.jumlah}</td>
          <td>${d.supplier}/${d.dept}</td>
          <td>${d.no_po}/${d.no_prs}</td>
          <td><button onclick="hapus('${s.key}')">Hapus</button></td>
        </tr>`;
    });
    riwayatBody.innerHTML=html;
  });
}

function hapus(id){
  if(confirm("Hapus data?")) db.ref("riwayat/"+id).remove();
}

function eksporExcel(){
  const wb=XLSX.utils.table_to_book(tabelRiwayat);
  XLSX.writeFile(wb,"Laporan_Gudang.xlsx");
}

window.onload=()=>{
  loadBarang();
  muatData();
}
</script>
