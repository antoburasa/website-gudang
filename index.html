<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SMS Gudang</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
.page{display:none}
.page.active{display:block}
.nav-active{background:#1e40af;color:white}
.input{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;margin-bottom:10px}
.btn{width:100%;padding:12px;border-radius:10px;font-weight:700;color:white}
</style>
</head>

<body class="bg-slate-100">

<!-- LOGIN -->
<div id="loginBox" class="fixed inset-0 flex items-center justify-center bg-slate-100 z-50">
<div class="bg-white p-8 rounded-xl w-80 shadow">
<h2 class="text-xl font-black mb-4">LOGIN</h2>
<input id="email" class="input" placeholder="Email">
<input id="password" type="password" class="input" placeholder="Password">
<button onclick="login()" class="btn bg-blue-600">Masuk</button>
</div>
</div>

<div class="flex min-h-screen">

<!-- SIDEBAR -->
<aside class="w-64 bg-white fixed h-full p-6 border-r">
<h1 class="text-xl font-black text-blue-700 mb-6">SMS GUDANG</h1>

<button onclick="buka('dash',this)" class="nav-btn nav-active w-full p-4 rounded-xl font-bold mb-2">
Dashboard
</button>
<button onclick="buka('master',this)" class="nav-btn w-full p-4 rounded-xl font-bold mb-2">
Master Barang
</button>
<button onclick="buka('masuk',this)" class="nav-btn w-full p-4 rounded-xl font-bold mb-2">
Barang Masuk
</button>
<button onclick="buka('keluar',this)" class="nav-btn w-full p-4 rounded-xl font-bold mb-2">
Barang Keluar
</button>
<button onclick="buka('log',this)" class="nav-btn w-full p-4 rounded-xl font-bold mb-2">
Riwayat
</button>

<button onclick="logout()" class="mt-6 text-red-600 font-bold">Logout</button>
</aside>

<!-- MAIN -->
<main class="flex-1 ml-64 p-10">

<!-- DASHBOARD -->
<section id="p-dash" class="page active">
<h2 class="text-3xl font-black mb-6">Dashboard</h2>

<div class="grid grid-cols-2 gap-6 mb-6">
<div class="bg-white p-6 rounded-xl">
<p class="text-xs text-slate-400">Total Barang</p>
<h3 id="statBarang" class="text-4xl font-black text-blue-600">0</h3>
</div>
<div class="bg-white p-6 rounded-xl">
<p class="text-xs text-slate-400">Total Stok</p>
<h3 id="statStok" class="text-4xl font-black text-green-600">0</h3>
</div>
</div>

<table class="w-full bg-white rounded-xl overflow-hidden">
<thead class="bg-slate-100 text-xs uppercase font-bold">
<tr><th class="p-4">Barang</th><th class="p-4 text-center">Stok</th></tr>
</thead>
<tbody id="listStok"></tbody>
</table>
</section>

<!-- MASTER -->
<section id="p-master" class="page">
<h2 class="text-3xl font-black mb-4">Master Barang</h2>

<input id="mNama" class="input" placeholder="Nama Barang">
<input id="mSatuan" class="input" placeholder="Satuan (PCS)">
<button onclick="saveMaster()" class="btn bg-blue-600 mb-4">Simpan</button>

<table class="w-full bg-white rounded-xl overflow-hidden">
<thead class="bg-slate-100 text-xs uppercase font-bold">
<tr><th class="p-4">Nama</th><th class="p-4">Satuan</th><th class="p-4 text-center">Aksi</th></tr>
</thead>
<tbody id="listMaster"></tbody>
</table>
</section>

<!-- MASUK -->
<section id="p-masuk" class="page">
<h2 class="text-3xl font-black text-green-600 mb-4">Barang Masuk</h2>
<input id="inNama" class="input" placeholder="Nama Barang">
<input id="inQty" type="number" class="input" placeholder="Jumlah">
<button onclick="aksi('MASUK')" class="btn bg-green-600">Simpan</button>
</section>

<!-- KELUAR -->
<section id="p-keluar" class="page">
<h2 class="text-3xl font-black text-red-600 mb-4">Barang Keluar</h2>
<input id="outNama" class="input" placeholder="Nama Barang">
<input id="outQty" type="number" class="input" placeholder="Jumlah">
<button onclick="aksi('KELUAR')" class="btn bg-red-600">Simpan</button>
</section>

<!-- RIWAYAT -->
<section id="p-log" class="page">
<h2 class="text-3xl font-black mb-4">Riwayat Transaksi</h2>
<button onclick="exportExcel()" class="mb-4 bg-green-600 text-white px-4 py-2 rounded-xl font-bold">
Export Excel
</button>

<table class="w-full bg-white rounded-xl overflow-hidden">
<thead class="bg-slate-100 text-xs uppercase font-bold">
<tr>
<th class="p-3">Waktu</th>
<th class="p-3">Barang</th>
<th class="p-3">Qty</th>
<th class="p-3">Tipe</th>
<th class="p-3">User</th>
</tr>
</thead>
<tbody id="listLog"></tbody>
</table>
</section>

</main>
</div>

<script>
// FIREBASE CONFIG
firebase.initializeApp({
apiKey: "AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
databaseURL: "https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const auth = firebase.auth();
const db = firebase.database();
let currentUser = "";

// AUTH
auth.onAuthStateChanged(u=>{
if(u){
currentUser = u.email;
loginBox.style.display='none';
}else{
loginBox.style.display='flex';
}
});

function login(){
auth.signInWithEmailAndPassword(email.value,password.value)
.catch(e=>alert(e.message));
}

function logout(){ auth.signOut(); }

// NAV
function buka(p,b){
document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('nav-active'));
document.getElementById('p-'+p).classList.add('active');
b.classList.add('nav-active');
}

// MASTER
function saveMaster(){
const n=mNama.value.trim();
const s=mSatuan.value.trim()||'PCS';
if(!n) return alert('Nama kosong');
db.ref('stok/'+n.toLowerCase()).set({nama:n,stok:0,satuan:s});
mNama.value=''; mSatuan.value='';
}

// MASUK / KELUAR
function aksi(tipe){
const nama=(tipe==='MASUK'?inNama.value:outNama.value).trim().toLowerCase();
const qty=parseInt(tipe==='MASUK'?inQty.value:outQty.value);
if(!nama||qty<=0) return alert('Input salah');

const ref=db.ref('stok/'+nama);
ref.once('value').then(s=>{
if(!s.exists()) return alert('Barang tidak ada');
let stok=s.val().stok||0;
stok=tipe==='MASUK'?stok+qty:stok-qty;
if(stok<0) return alert('Stok kurang');

ref.update({stok});
db.ref('transaksi').push({
nama:s.val().nama,
qty:qty,
tipe:tipe,
waktu:Date.now(),
user:currentUser
});
});
}

// REALTIME
db.ref('stok').on('value',s=>{
let h1='',h2='',j=0,t=0;
s.forEach(c=>{
const d=c.val(); j++; t+=d.stok;
h1+=<tr><td class="p-4">${d.nama}</td><td class="p-4 text-center font-black">${d.stok}</td></tr>;
h2+=`<tr><td class="p-4">${d.nama}</td><td class="p-4">${d.satuan}</td>
<td class="p-4 text-center">
<button onclick="db.ref('stok/${c.key}').remove()" class="text-red-600">
<i class="fa fa-trash"></i></button></td></tr>`;
});
listStok.innerHTML=h1;
listMaster.innerHTML=h2;
statBarang.innerText=j;
statStok.innerText=t;
});

// LOG
db.ref('transaksi').limitToLast(100).on('value',s=>{
let h='';
s.forEach(c=>{
const d=c.val();
h+=`<tr>
<td class="p-3">${new Date(d.waktu).toLocaleString()}</td>
<td class="p-3">${d.nama}</td>
<td class="p-3">${d.qty}</td>
<td class="p-3 font-bold">${d.tipe}</td>
<td class="p-3">${d.user}</td>
</tr>`;
});
listLog.innerHTML=h;
});

// EXPORT
function exportExcel(){
db.ref('transaksi').once('value').then(s=>{
let data=[['Waktu','Barang','Qty','Tipe','User']];
s.forEach(c=>{
const d=c.val();
data.push([
new Date(d.waktu).toLocaleString(),
d.nama,d.qty,d.tipe,d.user
]);
});
const wb=XLSX.utils.book_new();
const ws=XLSX.utils.aoa_to_sheet(data);
XLSX.utils.book_append_sheet(wb,ws,'Transaksi');
XLSX.writeFile(wb,'riwayat-transaksi.xlsx');
});
}
</script>

</body>
</html>
