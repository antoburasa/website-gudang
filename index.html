<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Gudang v2</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">

<style>
body{
font-family:'Plus Jakarta Sans',sans-serif;
background:#f1f5f9;
padding:20px;
color:#1e293b;
}

h2{
text-align:center;
margin-bottom:20px;
}

.dashboard{
display:grid;
grid-template-columns:1fr 1fr 1fr;
gap:10px;
margin-bottom:20px;
}

.box{
background:white;
padding:15px;
border-radius:12px;
text-align:center;
box-shadow:0 3px 6px rgba(0,0,0,0.08);
}

.big{
font-size:28px;
font-weight:800;
}

.card{
background:white;
padding:20px;
border-radius:12px;
margin-bottom:15px;
box-shadow:0 3px 6px rgba(0,0,0,0.08);
}

input,select{
width:100%;
padding:10px;
margin-top:8px;
border-radius:6px;
border:1px solid #cbd5e1;
}

button{
padding:10px;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
}

.btn{
background:#2563eb;
color:white;
}

.btn-warning{
background:#f59e0b;
color:white;
}

.btn-danger{
background:#ef4444;
color:white;
}

.btn-edit{
background:#10b981;
color:white;
}

table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}

th,td{
padding:10px;
border-bottom:1px solid #e2e8f0;
text-align:center;
}

.warning{
color:#ef4444;
font-weight:bold;
}
</style>
</head>

<body>

<h2>ðŸ“¦ SISTEM GUDANG v2</h2>

<div class="dashboard">
<div class="box">Total Stok<div id="totalStok" class="big">0</div></div>
<div class="box">Jenis Barang<div id="totalJenis" class="big">0</div></div>
<div class="box">Stok Warning<div id="stokWarning" class="big">0</div></div>
</div>

<div class="card">
<h3>Input Transaksi</h3>
<input id="barang" placeholder="Nama barang">
<select id="jenis">
<option value="masuk">Barang Masuk</option>
<option value="keluar">Barang Keluar</option>
</select>
<input id="jumlah" type="number" placeholder="Jumlah">
<button class="btn" onclick="prosesSimpan()">Simpan</button>
</div>

<div class="card">
<h3>Stok Saat Ini</h3>
<div id="ringkasanStok">Memuat data...</div>
</div>

<div class="card">
<h3>Riwayat Transaksi</h3>
<button class="btn-warning" onclick="backupExcel()">Backup Excel</button>

<table>
<thead>
<tr>
<th>Tanggal</th>
<th>Barang</th>
<th>Jenis</th>
<th>Jumlah</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="riwayatBody"></tbody>
</table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const firebaseConfig={
apiKey:"AIzaSyDbf4nf0iQleiB3R8Un89Gpi1Oio-tTB3o",
authDomain:"gudang-sms-4c81c.firebaseapp.com",
databaseURL:"https://gudang-sms-4c81c-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"gudang-sms-4c81c",
storageBucket:"gudang-sms-4c81c.appspot.com",
appId:"1:598362736106:web:c8e2732d6ac7613931de93"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let editId=null;
const MIN_STOK=5;

function prosesSimpan(){
const barang=document.getElementById("barang").value.trim().toUpperCase();
const jumlah=parseInt(document.getElementById("jumlah").value);
const jenis=document.getElementById("jenis").value;

if(!barang||!jumlah)return alert("Isi data!");

const data={
barang,jumlah,jenis,
tanggal:new Date().toISOString().slice(0,10)
};

if(editId){
db.ref("riwayat/"+editId).set(data);
editId=null;
}else{
db.ref("riwayat").push(data);
}

document.getElementById("barang").value="";
document.getElementById("jumlah").value="";
}

function editData(id,barang,jenis,jumlah){
editId=id;
document.getElementById("barang").value=barang;
document.getElementById("jenis").value=jenis;
document.getElementById("jumlah").value=jumlah;
}

function hapusData(id){
db.ref("riwayat/"+id).remove();
}

function backupExcel(){
const table=document.querySelector("table");
const wb=XLSX.utils.table_to_book(table);
XLSX.writeFile(wb,"Backup_Gudang.xlsx");
}

function autoBackup(dataArray){
const ws=XLSX.utils.json_to_sheet(dataArray);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Backup");
XLSX.writeFile(wb,"AutoBackupGudang.xlsx");
}

function muatData(){
db.ref("riwayat").on("value",snap=>{
let html="";
let stok={};
let total=0;
let warningCount=0;
let backupData=[];

snap.forEach(child=>{
const d=child.val();
if(!d)return;

backupData.push(d);

const jumlah=parseInt(d.jumlah)||0;

if(d.jenis==="masuk"){
stok[d.barang]=(stok[d.barang]||0)+jumlah;
total+=jumlah;
}else{
stok[d.barang]=(stok[d.barang]||0)-jumlah;
total-=jumlah;
}

html+=`
<tr>
<td>${d.tanggal}</td>
<td>${d.barang}</td>
<td>${d.jenis}</td>
<td>${jumlah}</td>
<td>
<button class="btn-edit" onclick="editData('${child.key}','${d.barang}','${d.jenis}',${jumlah})">Edit</button>
<button class="btn-danger" onclick="hapusData('${child.key}')">Hapus</button>
</td>
</tr>`;
});

document.getElementById("riwayatBody").innerHTML=html;

let ringkasan="";
for(let b in stok){
const val=stok[b];
if(val<=MIN_STOK)warningCount++;

ringkasan+=`
<div style="display:flex;justify-content:space-between;padding:6px">
<span>${b}</span>
<b class="${val<=MIN_STOK?'warning':''}">${val}</b>
</div>`;
}

document.getElementById("ringkasanStok").innerHTML=ringkasan;
document.getElementById("totalStok").innerText=total;
document.getElementById("totalJenis").innerText=Object.keys(stok).length;
document.getElementById("stokWarning").innerText=warningCount;

if(backupData.length>0)autoBackup(backupData);
});
}

window.onload=muatData;
</script>

</body>
</html>
