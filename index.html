from flask import Flask, render_template_string, request, redirect, url_for
import sqlite3
import datetime

app = Flask(__name__)
DB = "prs.db"

# ================= DB =================
def init_db():
    conn = sqlite3.connect(DB)
    c = conn.cursor()

    c.execute("""
    CREATE TABLE IF NOT EXISTS barang(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nama TEXT,
        uom TEXT
    )
    """)

    c.execute("""
    CREATE TABLE IF NOT EXISTS prs(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nomor TEXT,
        tanggal TEXT,
        divisi TEXT
    )
    """)

    c.execute("""
    CREATE TABLE IF NOT EXISTS prs_detail(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        prs_id INTEGER,
        barang_id INTEGER,
        qty INTEGER
    )
    """)

    conn.commit()
    conn.close()

init_db()

# ================= MASTER BARANG =================
@app.route("/barang", methods=["GET", "POST"])
def barang():
    conn = sqlite3.connect(DB)
    c = conn.cursor()

    if request.method == "POST":
        nama = request.form["nama"]
        uom = request.form["uom"]
        c.execute("INSERT INTO barang(nama,uom) VALUES(?,?)", (nama, uom))
        conn.commit()

    data = c.execute("SELECT * FROM barang").fetchall()
    conn.close()

    return render_template_string("""
    <h2>Master Barang</h2>
    <form method="post">
        Nama Barang <input name="nama">
        UOM <input name="uom">
        <button>Simpan</button>
    </form>
    <hr>
    <a href="/">Kembali</a>
    <table border=1>
    <tr><th>ID</th><th>Nama</th><th>UOM</th></tr>
    {% for d in data %}
    <tr>
        <td>{{d[0]}}</td>
        <td>{{d[1]}}</td>
        <td>{{d[2]}}</td>
    </tr>
    {% endfor %}
    </table>
    """, data=data)

# ================= BUAT PRS =================
@app.route("/buat_prs", methods=["GET", "POST"])
def buat_prs():
    conn = sqlite3.connect(DB)
    c = conn.cursor()

    barang = c.execute("SELECT * FROM barang").fetchall()

    if request.method == "POST":
        nomor = request.form["nomor"]
        divisi = request.form["divisi"]
        tanggal = datetime.date.today()

        c.execute(
            "INSERT INTO prs(nomor,tanggal,divisi) VALUES(?,?,?)",
            (nomor, tanggal, divisi),
        )
        prs_id = c.lastrowid

        for b in barang:
            field = "qty_" + str(b[0])
            if request.form[field] != "":
                qty = request.form[field]
                c.execute(
                    "INSERT INTO prs_detail(prs_id,barang_id,qty) VALUES(?,?,?)",
                    (prs_id, b[0], qty),
                )

        conn.commit()
        return redirect("/")

    conn.close()

    return render_template_string("""
    <h2>Buat PRS</h2>
    <form method="post">
        Nomor PRS <input name="nomor"><br><br>
        Divisi <input name="divisi"><br><br>

        <table border=1>
        <tr>
            <th>Barang</th>
            <th>UOM</th>
            <th>Qty</th>
        </tr>
        {% for b in barang %}
        <tr>
            <td>{{b[1]}}</td>
            <td>{{b[2]}}</td>
            <td>
                <input name="qty_{{b[0]}}" style="width:60px">
            </td>
        </tr>
        {% endfor %}
        </table>
        <br>
        <button>Simpan PRS</button>
    </form>
    """, barang=barang)

# ================= LIST PRS =================
@app.route("/")
def index():
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    data = c.execute("SELECT * FROM prs ORDER BY id DESC").fetchall()
    conn.close()

    return render_template_string("""
    <h2>DATA PRS</h2>
    <a href="/barang">Master Barang</a> |
    <a href="/buat_prs">Buat PRS</a>
    <hr>

    <table border=1>
    <tr>
        <th>No PRS</th>
        <th>Tanggal</th>
        <th>Divisi</th>
        <th>Print</th>
    </tr>
    {% for d in data %}
    <tr>
        <td>{{d[1]}}</td>
        <td>{{d[2]}}</td>
        <td>{{d[3]}}</td>
        <td><a href="/print/{{d[0]}}">Print</a></td>
    </tr>
    {% endfor %}
    </table>
    """, data=data)

# ================= PRINT =================
@app.route("/print/<int:id>")
def print_prs(id):
    conn = sqlite3.connect(DB)
    c = conn.cursor()

    prs = c.execute("SELECT * FROM prs WHERE id=?", (id,)).fetchone()

    detail = c.execute("""
    SELECT barang.nama, barang.uom, prs_detail.qty
    FROM prs_detail
    JOIN barang ON barang.id = prs_detail.barang_id
    WHERE prs_detail.prs_id=?
    """, (id,)).fetchall()

    conn.close()

    return render_template_string("""
    <h3 style="text-align:center">PURCHASE REQUEST SLIP</h3>
    <hr>
    No PRS : {{prs[1]}}<br>
    Tanggal : {{prs[2]}}<br>
    Divisi : {{prs[3]}}<br><br>

    <table border=1 width="100%" cellspacing=0 cellpadding=5>
    <tr>
        <th>No</th>
        <th>Description</th>
        <th>UOM</th>
        <th>Qty</th>
    </tr>
    {% for d in detail %}
    <tr>
        <td>{{loop.index}}</td>
        <td>{{d[0]}}</td>
        <td>{{d[1]}}</td>
        <td>{{d[2]}}</td>
    </tr>
    {% endfor %}
    </table>

    <br><br>
    <button onclick="window.print()">PRINT</button>
    """, prs=prs, detail=detail)

app.run(debug=True)
