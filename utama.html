// Fungsi Utama untuk Masuk & Keluar
        function proses(mode) {
            const nama = document.getElementById(mode === 'masuk' ? 'namaIn' : 'namaOut').value.trim().toLowerCase();
            const jml = parseInt(document.getElementById(mode === 'masuk' ? 'jmlIn' : 'jmlOut').value);
            const sat = document.getElementById('satIn').value || "Pcs";
            const waktu = new Date().toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });

            if (!nama || isNaN(jml)) return alert("Mohon lengkapi Nama Barang dan Jumlah!");

            const refStok = db.ref('stok/' + nama);
            // KUNCI PERBAIKAN: push() harus selalu menghasilkan ID unik baru
            const refLog = db.ref('riwayat').push(); 

            refStok.once('value').then(s => {
                let current = s.exists() ? parseInt(s.val().stok) : 0;
                let baru = (mode === 'masuk') ? (current + jml) : (current - jml);
                if (baru < 0) return alert("Stok tidak mencukupi!");

                // Simpan Stok
                refStok.update({ nama, stok: baru, satuan: sat, update: waktu });
                
                // Simpan Riwayat Baru (Ini yang akan membuat daftar jadi panjang)
                refLog.set({ 
                    waktu: waktu, 
                    tipe: mode, 
                    nama: nama, 
                    qty: (mode === 'masuk' ? '+' : '-') + jml 
                });

                alert("Data " + nama + " berhasil diperbarui!");
                // Reset input setelah berhasil
                document.getElementById('namaIn').value=''; document.getElementById('jmlIn').value='';
                document.getElementById('namaOut').value=''; document.getElementById('jmlOut').value='';
            });
        }

        // Tampilkan Riwayat (Selalu memantau perubahan)
        db.ref('riwayat').on('value', snap => {
            let h = ""; 
            let list = [];
            snap.forEach(c => {
                list.push(c.val());
            });
            // Balik urutan agar yang terbaru di atas, ambil 15 data terakhir
            list.reverse().slice(0, 15).forEach(v => {
                const warnaAksi = v.tipe === 'masuk' ? 'text-emerald-600' : 'text-rose-600';
                h += `<tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                    <td class="p-3 text-slate-400 font-mono text-[9px]">${v.waktu}</td>
                    <td class="p-3 font-black ${warnaAksi} uppercase text-[10px]">${v.tipe}</td>
                    <td class="p-3 capitalize font-bold text-slate-700">${v.nama}</td>
                    <td class="p-3 text-right font-black text-slate-800 bg-slate-50/50">${v.qty}</td>
                </tr>`;
            });
            document.getElementById('tbLog').innerHTML = h || '<tr><td colspan="4" class="p-10 text-center text-slate-300 italic">Belum ada transaksi...</td></tr>';
        });